# 系统管理

## 进程管理

### 查看所有进程
  - `ps aux` 查看系统中所有进程，使用BSD模式
  - `ps -le` 查看系统中所有的进程，使用linux标准命令格式
     选项：
      - `-a`：显示一个终端的所有进程，除了会话引线
      - `-u`：显示进程的归属用户及内存的使用情况
      - `-x`：显示没有控制终端的进程
      - `-l`：长格式显示。显示更加详细的信息
      - `-e`：显示所有进程，和`-A`作用一致
  - `stat`：进程状态。常见的状态有：
    - R：运行
    - S：睡眠
    - T：停止状态
    - s：包含子进程
    - +：位于后台
  - `pstree` 树形显示进程树
    选项：
      - `-p`：显示进程的PID
      - `-u`：显示进程所属用户

### `top` 命令
选项：
  - `-d`：指定top命令更新间隔，单位为秒
  - `-b`：使用批处理模式输出，一般和`-n`选项合用
  - `-n`：指定top命令执行的次数，一般和`-b`合用

  在top命令交互模式中的命令：
  - `？`或`h`：显示帮助
  - `P`：以CPU使用率排序，默认项
  - `M`：以内存的使用率排序
  - `N`：以PID排序


******
## 工作管理
- 将前台占用bash的进程放入后台（相当于windows中的最小化）：在命令后加`&`
- `jobs -l` 查看后台工作列表
- `fg %[工作号]` 将后台暂停的工作恢复到前台，`%`可以省略
- `bg %[工作号]` 将后台暂停的工作恢复到后台执行

*** 注意：后台进程会在终端退出后停止。 ***

后台进程脱离终端的方法：
1. 将命令写入`/etc/rc.local`，该文件中的命令会在系统启动后自动运行
2. 使用系统定时任务
3. 使用`nohup`命令:`nohup [命令] &`

*****
## 资源监视
- `vmstat`命令监控系统资源
`vmstat [刷新延时] [刷新次数]`
- `dmesg`显示内核自检信息
- `free`命令查看内存使用状态
  `free [选项]`
  选项：
  - `-b`：以字节为单位显示
  - `-k`：以KB为单位显示（默认选项）
  - `-m`：以MB为单位显示
  - `-g`：以GB为单位显示
- 查看CPU信息：`cat /proc/cpuinfo`
- `uptime`:系统运行时长，当前用户、平均负载信息
- `uname [选项]`命令查看系统与内核相关信息
  选项：
  - `-a`：查看系统所有相关细信息
  - `-r`：查看内核版本
  - `-s`：查看内核名称
- `lsb_release -a` 查询当前linux系统的发型版本
- `lsof [选项]` 列出进程打开或使用的文件信息
  选项：
  - `-c`：只列出以字符串开头的进程打开的文件
  - `-u [用户名]`：只列出某个用户的进程打开的文件
  - `-p [PID]`：列出某个PID进程打开的文件
  - `lsof [系统文件]`： 查看系统文件被哪个进程调用
  - `lsof -c [进程名]`：查看进程调用了那些文件

## 定时任务
### crontab 基本使用

- `crontab -e` 进入编辑器，编辑任务，编辑当前用户的定时任务，如果没有当前用户的配置文件，则会在/var/spool/cron/crontabs 下创建一个以用户名为名的文件
- `crontab -l` 列出当前用户的crontab任务
- `crontab -r` 清除所有的crontab任务

crontab -e 创建的文件编辑格式：

```shell
# m h  dom mon dow   command
```

分别为: `分 时 日 月 星期几 执行的命令`

查看crontab服务状态：
	
> service crond status

手动启动crontab服务：
	
> service crond start

### crontab 文件编辑

日志文件: ll /var/log/cron*
编辑文件: vim /etc/crontab

/etc/crontab 下文件的编辑格式：

```shell
# m h dom mon dow user  command
```

分别为: `分 时 日 月 星期几 用户 执行的命令`

### 介绍crontab文件
- /etc/crontab
在这个文件里并没有记录系统要执行哪些工作，而是记录了下面四个子目录。
- /etc/cron.hourly
- /etc/cron.daily
- /etc/cron.weekly
- /etc/cron.monthly

这些子目录里存放了一些脚本，到了crontab所指定的时间点，系统就会去执行这些子目录里的脚本。 

### 限制对 cron 的使用

/etc/cron.allow和/etc/cron.deny 文件被用来限制对 cron 的使用。

- 这两个使用控制文件的格式都是每行一个用户。两个文件都不允许空格。如果使用控制文件被修改了，cron 守护进程（crond）不必被重启。
- 使用控制文件在每次用户添加或删除一项 cron 任务时都会被读取。无论使用控制文件中的规定如何，root 都总是可以使用 cron。
- 如果 cron.allow 文件存在，只有其中列出的用户才被允许使用 cron，并且 cron.deny 文件会被忽略。
- 如果 cron.allow 文件不存在，所有在 cron.deny 中列出的用户都被禁止使用 cron。

### 脚本

执行脚本的command：

> bash ...../shell_to_be_excuted.sh

**注意：**

1. 环境变量问题，例如crontab不能识别Java的环境变量
    crontab执行shell时，只能识别为数不多的环境变量，普通的环境变量是无法识别的，所以在编写shell时，**最好使用export重新声明变量，确保脚本执行**。 
2. 命令的执行最好用脚本
3. **脚本权限加/bin/sh**，规范路径/server/scripts
4. 时间变量用反斜线转义，最好用脚本
5. 定时任务添加注释
7. **定时任务里面的程序脚本尽量用全路径**
8. 避免不必要的程序以及命令输出
9. 定时任务之前添加注释
10. 打包到文件目录的上一级
11. 当crontab突然失效时，可以尝试/etc/init.d/crond restart解决问题。或者查看日志看某个job有没有执行/报错tail -f /var/log/cron。
12. **千万别乱运行crontab -r**。它从Crontab目录（/var/spool/cron）中删除用户的Crontab文件。删除了该用户的所有crontab都没了。
13. 在crontab中%是有特殊含义的，表示换行的意思。如果要用的话必须进行转义\%，如经常用的date ‘+%Y%m%d’在crontab里是不会执行的，应该换成date ‘+\%Y\%m\%d’